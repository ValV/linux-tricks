##### [Навигатор заметок](index.md)

## Как выделить свободное место перед логическим томом

Пришлось столкнуться с такой задачей - выделить свободное место перед логическим томом, который находится в начале группы томов (и в начале физического тома). Для примера можно это можно условно изобразить следующим образом:
```
 +------------------------------------+------------------------------------+
 |          Логический том 1          |          Логический том 2          |
 |          114688 экстентов          |          409600 экстентов          |
 |------------------------------------+------------------------------------|
 |                         Группа логических томов                         |
 |-------------------------------------------------------------------------|
 |                              Физический том                             |
 +-------------------------------------------------------------------------+
```
Для этого потребуется уменьшить и сдвинуть логический том внутри логической группы относительно начала этой группы, например так:
```
 +-----------------------+------------------------+------------------------+
 |    Свободное место    |    Логический том 1    |    Логический том 2    |
 |    16384 экстентов    |     98304 экстентов    |    409600 экстентов    |
 |-----------------------+------------------------+------------------------|
 |                         Группа логических томов                         |
 |-------------------------------------------------------------------------|
 |                              Физический том                             |
 +-------------------------------------------------------------------------+
```
В стандартном наборе *lvm2* имеется три команды для изменения геометрии логических томов (в сущности, одна команда с разными параметрами по умолчанию): *lvresize*, *lvreduce* и *lvextend* - для изменения размера, уменьшения размера и увеличения размера соответственно (предполагается, что *lvcreate* и *lvremove* не изменяют размеры, пусть даже и на 100%). Но нет команды *lvmove* или чего-то в это роде. К счастью, есть команда *pvmove*, которая перемещает физические экстенты (куски физического тома) в различных направлениях, в различных количествах и в различные физические тома.

В общем, идея состоит в том, чтобы уменьшить *логический том 1* до размера требуемого свободного пространства (16384 экстентов), переместить блоки физического тома (экстенты) с 0-16383 в 16384-32767, а затем снова увеличить размер до 114687 куска-экстента. Также предполагается, что внутри *логического тома 1* имеется файловая система *ext4*, в которой достаточно свободного места, чтобы уменьшить до размера в 16384 экстента. *Логический том 2* далее интересовать не будет, предполагается, что он не перемещаемый и не удаляемый, нужен только для примера.

##### Примечание
Реально размер экстента может соответствовать различному количеству байт, например, 1 экстент = 2 Мбайта. В таком случае, объём данных в файловой системе должен быть меньше 16384 * 2 = 32768 Мбайт или 32 Гбайт (если 1 Мбайт = 1024 Кбайт, а 1 Гбайт = 1024 Мбайт).

Уменьшение размера *логического тома 1* (*lv1*) в составе логической группы (*vg0*) на 98304 (114688 - 16384) экстентов:
```
lvreduce -l -98304 -r vg0/lv1
```
Здесь ключ `-r` указывает также автоматически уменьшить размер файловой системы до нужного размера (при помощи программы *fsadm*). Знак "минус" перед значением ключа `-l` сообщает программе о том, что нужно использовать относительный размер (на 98304 кусков меньше).

Посмотреть, что в результате получилось, можно при помощи команды *pvdisplay*, т. е. показать информацию о физическом томе *pv0* (который может быть представлен, например, ссылкой на *sdb3*: `pv0 --> sdb3`), поверх которого располагается группа томов *vg0*:
```
# pvdisplay -m /dev/pv0

  --- Physical volume ---
  PV Name               /dev/pv0
  VG Name               vg0
  PV Size               224.00 GiB
  Allocatable           yes
  PE Size               2.00 MiB
  Total PE              114688
  Free PE               98304
  Allocated PE          16384
  PV UUID               da58Jn-b2eo-RRo3-SgW3-07rQ-lle2-Ne6jbs
   
  --- Physical Segments ---
  Physical extent 0 to 16383:
    Logical volume	/dev/vg0/lv1
    Logical extents	0 to 16383
  Physical extent 16384 to 114687:
    FREE

```
Здесь `/dev/pv0` равносильно `/dev/sdb3`, а ключ `-m` говорит о том, чтобы отобразить карту размещения физических экстентов.

Перемещение физических экстентов (сдвиг) в пределах одного физического тома *pv0*:
```
pvmove --alloc anywhere /dev/pv0:0-16383 /dev/pv0:16384+16384
```
Способ размещения экстентов должен быть указан явно `--alloc anywhere`, т. к. перемещение кусков происходит внутри одного физического тома (тут явное перемешивание). Через двоеточие после тома-источника и тома-назначения указываются диапазоны, во втором случае диапазон указан неявно (начало+смещение).

После чего *pvdisplay* покажет следующее:
```
# pvdisplay -m /dev/pv0

  --- Physical volume ---
  PV Name               /dev/pv0
  VG Name               vg0
  PV Size               224.00 GiB
  Allocatable           yes
  PE Size               2.00 MiB
  Total PE              114688
  Free PE               98304
  Allocated PE          16384
  PV UUID               da58Jn-b2eo-RRo3-SgW3-07rQ-lle2-Ne6jbs
   
  --- Physical Segments ---
  Physical extent 0 to 16383:
    FREE
  Physical extent 16384 to 32767:
    Logical volume	/dev/vg0/lv1
    Logical extents	0 to 16383
  Physical extent 32768 to 114687:
    FREE

```
Теперь *логическому тому 1* физически предшествует свободное место в 16384 экстентов. Т. е. это почти то, что нужно было.

Оставшееся после логического тома место заполняется при помощи *lvextend*:
```
# lvextend --alloc contuguous -r --type linear -l +81920 vg0/lv1
```
Здесь способ размещения экстентов `--alloc contiguous` непрерывный, а тип разбиения на сегметы `--type linear` линейный. Новый размер логического тома, как и в случае с уменьшением размера -- относительный (разница между последним свободным экстентом и последним экстентом логического тома: 114687 - 32767).

В результате получается совсем то, что нужно:
```
# pvdisplay -m /dev/pv0

  --- Physical volume ---
  PV Name               /dev/pv0
  VG Name               vg0
  PV Size               224.00 GiB
  Allocatable           yes
  PE Size               2.00 MiB
  Total PE              114688
  Free PE               16384
  Allocated PE          98304
  PV UUID               da58Jn-b2eo-RRo3-SgW3-07rQ-lle2-Ne6jbs
   
  --- Physical Segments ---
  Physical extent 0 to 16383:
    FREE
  Physical extent 16384 to 114687:
    Logical volume	/dev/vg0/lv1
    Logical extents	0 to 98303

```

Как ещё один возможный вариант - это уменьшить логический том не до размера свободного пространства, а сразу до необходимного размера (исходный размер минус свободное место). В этом случае после логического тома образуется свободное место, а перемещать придётся пачками экстентов размером, соответствующим размеру свободного места. Т. е. потребуется несколько операций перемещения (в зависимости от размеров логического тома и свободного места). Полезно, если объём полезных данных не позволяет уменьшить файловую систему до размера свободного места без потерь. Также очевидно, что количество операций перемещения прямо пропорционально отношению нового размера логического тома к размеру выделенного свободного места.

##### [Навигатор заметок](index.md)
